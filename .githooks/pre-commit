#!/usr/bin/env sh

set -eu

if ! command -v gofmt >/dev/null 2>&1; then
  echo "pre-commit: gofmt is required but not found in PATH" >&2
  exit 1
fi

echo "pre-commit: checking gofmt"
unformatted="$(gofmt -l .)"
if [ -n "$unformatted" ]; then
  echo "pre-commit: files must be gofmt-formatted:" >&2
  echo "$unformatted" >&2
  echo "pre-commit: run 'gofmt -w .' and re-commit" >&2
  exit 1
fi

LINT_CMD=""
if command -v golangci-lint >/dev/null 2>&1; then
  LINT_CMD="golangci-lint"
elif [ -x "$HOME/go/bin/golangci-lint" ]; then
  LINT_CMD="$HOME/go/bin/golangci-lint"
else
  echo "pre-commit: golangci-lint is required but not found in PATH or \$HOME/go/bin" >&2
  echo "pre-commit: install from https://golangci-lint.run/welcome/install/" >&2
  exit 1
fi

echo "pre-commit: running ${LINT_CMD} run"
"$LINT_CMD" run

echo "pre-commit: lint checks passed"
